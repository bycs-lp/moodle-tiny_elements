{"version":3,"file":"data.min.js","sources":["../src/data.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Container for tiny_elements data (categories, components, flavors, variants).\n *\n * @module     tiny_elements/data\n * @copyright  2025 ISB Bayern\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {get_strings as getStrings} from 'core/str';\nimport {component as pluginname} from './common';\nimport {\n    variantExists,\n    setData as setVariantsData\n} from './variantslib';\nimport {\n    findById,\n    findByName\n} from './helper';\nimport {call as fetchMany} from 'core/ajax';\n\nexport default class Data {\n    categories = [];\n    components = [];\n    flavors = [];\n    variants = [];\n    langStrings = {};\n    userStudent = false;\n    contextid = 1;\n\n    constructor(contextid, userStudent, previewElements) {\n        this.contextid = contextid;\n        this.userStudent = userStudent;\n        this.previewElements = previewElements;\n        setVariantsData(this);\n    }\n\n    async loadData() {\n        await this.loadElementsData();\n        this.langStrings = await this.getAllStrings();\n    }\n\n    getComponents() {\n        return this.components;\n    }\n\n    getFlavors() {\n        return this.flavors;\n    }\n\n    getVariants() {\n        return this.variants;\n    }\n\n    getComponentById(id) {\n        return findById(this.components, id);\n    }\n\n    getCategoryFlavors(categoryId) {\n        const categoryFlavors = [];\n        this.flavors.forEach(flavor => {\n            if (flavor.categories == categoryId || flavor.categories.split(',').includes(categoryId)) {\n                categoryFlavors.push({\n                    id: flavor.id,\n                    name: flavor.name,\n                    displayname: flavor.displayname,\n                    displayorder: flavor.displayorder,\n                });\n            }\n        });\n        return categoryFlavors;\n    }\n\n    /**\n     * Get the Elements categories for the dialogue.\n     *\n     * @returns {object} data\n     */\n    getCategories() {\n        const cats = [];\n        // Iterate over contexts.\n        this.categories.forEach((category) => {\n            let categoryFlavors = this.getCategoryFlavors(category.id);\n            categoryFlavors.sort((a, b) => a.displayorder - b.displayorder);\n            let hasFlavors = Array.isArray(categoryFlavors) && categoryFlavors.length;\n            cats.push({\n                categoryid: category.id,\n                name: category.displayname,\n                type: category.id,\n                displayorder: category.displayorder,\n                flavors: categoryFlavors,\n                hasFlavors: hasFlavors,\n                active: '',\n            });\n        });\n        // Sort by displayorder and set first to active.\n        cats.sort((a, b) => a.displayorder - b.displayorder);\n        if (cats.length > 0) {\n            cats[0].active = 'active';\n            if (cats[0].flavors.length > 0) {\n                cats[0].flavors[0].factive = 'active';\n            }\n        }\n\n        return cats;\n    }\n\n    getComponentVariants(component) {\n        const componentVariants = [];\n        component.variants.forEach(variant => {\n            let variantitem = findByName(this.variants, variant);\n            if (variantitem !== undefined) {\n                let state = variantExists(component.name, variantitem.name) ? 'on' : 'off';\n                componentVariants.push({\n                    id: variantitem.id,\n                    name: variantitem.name,\n                    state: state,\n                    imageClass: variantitem.name + '-variant-' + state,\n                    variantclass: (variantitem.c4lcompatibility ? 'c4l' : 'elements') + '-' + variantitem.name + '-variant',\n                    title: this.langStrings.get(variantitem.name),\n                    content: variantitem.content,\n                });\n            }\n        });\n        return componentVariants;\n    }\n\n    getCategoryById(id) {\n        return findById(this.categories, id);\n    }\n\n    getLangString(id) {\n        return this.langStrings.get(id);\n    }\n\n    /**\n     * Get the Elements buttons for the dialogue.\n     *\n     * @param {Editor} editor\n     * @returns {object} buttons\n     */\n    getButtons(editor) {\n        const buttons = [];\n        // Not used at the moment.\n        // eslint-disable-next-line no-unused-vars\n        const sel = editor.selection.getContent();\n        Object.values(this.components).forEach(component => {\n            buttons.push({\n                id: component.id,\n                name: component.displayname,\n                type: component.compcat,\n                imageClass: 'elements-' + component.name + '-icon',\n                htmlcode: component.code,\n                variants: this.getComponentVariants(component),\n                flavorlist: component.flavors.join(','),\n                category: component.compcat,\n                displayorder: component.displayorder,\n            });\n        });\n        buttons.sort((a, b) => a.displayorder - b.displayorder);\n\n        return buttons;\n    }\n\n    /**\n     * Get the template context for the dialogue.\n     *\n     * @param {Editor} editor\n     * @returns {object} data\n     */\n    getTemplateContext(editor) {\n        return Object.assign({}, {\n            elementid: editor.id,\n            buttons: this.getButtons(editor),\n            categories: this.getCategories(),\n            preview: this.previewElements,\n        });\n    }\n\n    getPreviewElements() {\n        return this.previewElements;\n    }\n\n    /**\n     * Get language strings.\n     *\n     * @return {object} Language strings\n     */\n    async getAllStrings() {\n        const keys = [];\n        const compRegex = /{{#([^}]*)}}/g;\n\n        this.components.forEach(element => {\n            // Get lang strings from components.\n            [...element.code.matchAll(compRegex)].forEach(strLang => {\n                if (keys.indexOf(strLang[1]) === -1) {\n                    keys.push(strLang[1]);\n                }\n            });\n\n            // Get lang strings from text placeholders.\n            [...element.text.matchAll(compRegex)].forEach(strLang => {\n                if (keys.indexOf(strLang[1]) === -1) {\n                    keys.push(strLang[1]);\n                }\n            });\n        });\n\n        const stringValues = await getStrings(keys.map((key) => ({key, pluginname})));\n        return new Map(keys.map((key, index) => ([key, stringValues[index]])));\n    }\n\n    async loadElementsData() {\n        const data = await fetchMany([{\n            methodname: 'tiny_elements_get_elements_data',\n            args: {\n                isstudent: this.userStudent,\n                contextid: this.contextid\n            },\n        }])[0];\n\n        // TODO error handling.\n        const indexedComponents = [];\n        data.components.forEach(component => {\n            indexedComponents[component.id] = component;\n        });\n\n        const indexedVariants = [];\n        data.variants.forEach(variant => {\n            indexedVariants[variant.id] = variant;\n        });\n\n        const indexedCategories = [];\n        data.categories.forEach(category => {\n            indexedCategories[category.id] = category;\n        });\n\n        this.components = indexedComponents;\n        this.variants = indexedVariants;\n        this.categories = indexedCategories;\n        this.flavors = data.flavors;\n    }\n}\n"],"names":["constructor","contextid","userStudent","previewElements","this","loadElementsData","langStrings","getAllStrings","getComponents","components","getFlavors","flavors","getVariants","variants","getComponentById","id","getCategoryFlavors","categoryId","categoryFlavors","forEach","flavor","categories","split","includes","push","name","displayname","displayorder","getCategories","cats","category","sort","a","b","hasFlavors","Array","isArray","length","categoryid","type","active","factive","getComponentVariants","component","componentVariants","variant","variantitem","undefined","state","imageClass","variantclass","c4lcompatibility","title","get","content","getCategoryById","getLangString","getButtons","editor","buttons","selection","getContent","Object","values","compcat","htmlcode","code","flavorlist","join","getTemplateContext","assign","elementid","preview","getPreviewElements","keys","compRegex","element","matchAll","strLang","indexOf","text","stringValues","map","key","pluginname","Map","index","data","methodname","args","isstudent","indexedComponents","indexedVariants","indexedCategories"],"mappings":"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"}