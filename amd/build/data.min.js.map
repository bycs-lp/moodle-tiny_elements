{"version":3,"file":"data.min.js","sources":["../src/data.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Container for tiny_elements data (categories, components, flavors, variants).\n *\n * @module     tiny_elements/data\n * @copyright  2025 ISB Bayern\n * @author     Stefan Hanauska <stefan.hanauska@csg-in.de>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {get_strings as getStrings} from 'core/str';\nimport {component as pluginname} from 'tiny_elements/common';\nimport {\n    variantExists,\n    setData as setVariantsData\n} from './variantslib';\nimport {\n    findById,\n    findByName\n} from './helper';\nimport {call as fetchMany} from 'core/ajax';\nimport Log from 'core/log';\n\nexport default class Data {\n    categories = [];\n    components = [];\n    flavors = [];\n    variants = [];\n    langStrings = {};\n    userStudent = false;\n    canManage = false;\n    contextid = 1;\n\n    constructor(contextid, userStudent, previewElements, canManage) {\n        this.contextid = contextid;\n        this.userStudent = userStudent;\n        this.previewElements = previewElements;\n        this.canManage = canManage;\n        setVariantsData(this);\n    }\n\n    async loadData() {\n        await this.loadElementsData();\n        this.langStrings = await this.getAllStrings();\n    }\n\n    getComponents() {\n        return this.components;\n    }\n\n    getFlavors() {\n        return this.flavors;\n    }\n\n    getVariants() {\n        return this.variants;\n    }\n\n    getComponentById(id) {\n        return findById(this.components, id);\n    }\n\n    getCategoryFlavors(categoryname) {\n        const categoryFlavors = [];\n        this.flavors.forEach(flavor => {\n            if (flavor.categoryname == categoryname) {\n                categoryFlavors.push({\n                    id: flavor.id,\n                    name: flavor.name,\n                    displayname: flavor.displayname,\n                    displayorder: flavor.displayorder,\n                });\n            }\n        });\n        return categoryFlavors;\n    }\n\n    /**\n     * Get the Elements categories for the dialogue.\n     *\n     * @returns {object} data\n     */\n    getCategories() {\n        const cats = [];\n        const flexbasis = this.setFlexbasis();\n        // Iterate over contexts.\n        this.categories.forEach((category) => {\n            let categoryFlavors = this.getCategoryFlavors(category.name);\n            categoryFlavors.sort((a, b) => a.displayorder - b.displayorder);\n            let hasFlavors = Array.isArray(categoryFlavors) && categoryFlavors.length;\n            let flexbasisrng = flexbasis;\n            if (category.displayorder % 2 == 0) {\n                // Set flexbases minus 1,2 or 3 for visual purposes.\n                flexbasisrng = flexbasis - (Math.floor(Math.random() * 3) + 1);\n            }\n            cats.push({\n                categoryid: category.id,\n                name: category.displayname,\n                categoryname: category.name,\n                type: category.id,\n                displayorder: this.categories.length - category.displayorder,\n                flexbasis: flexbasisrng,\n                flavors: categoryFlavors,\n                hasFlavors: hasFlavors,\n                active: '',\n            });\n        });\n        // Sort by displayorder and set first to active.\n        cats.sort((a, b) => a.displayorder - b.displayorder);\n        if (cats.length > 0) {\n            cats[0].active = 'active';\n            if (cats[0].flavors.length > 0) {\n                cats[0].flavors[0].factive = 'active';\n            }\n        }\n\n        return cats;\n    }\n\n    getComponentVariants(component) {\n        const componentVariants = [];\n        component.variants.forEach(variant => {\n            let variantitem = findByName(this.variants, variant);\n            if (variantitem !== undefined) {\n                let state = variantExists(component.name, variantitem.name) ? 'on' : 'off';\n                componentVariants.push({\n                    id: variantitem.id,\n                    name: variantitem.name,\n                    displayname: variantitem.displayname,\n                    state: state,\n                    imageClass: variantitem.name + '-variant-' + state,\n                    variantclass: (variantitem.c4lcompatibility ? 'c4l' : 'elements') + '-' + variantitem.name + '-variant',\n                    title: this.langStrings.get(variantitem.name),\n                    content: variantitem.content,\n                });\n            }\n        });\n        componentVariants.sort((a, b) => (a.name.localeCompare(b.name)));\n        return componentVariants;\n    }\n\n    getCategoryById(id) {\n        return findById(this.categories, id);\n    }\n\n    getLangString(id) {\n        return this.langStrings.get(id);\n    }\n\n    /**\n     * Get the Elements buttons for the dialogue.\n     *\n     * @param {Editor} editor\n     * @returns {object} buttons\n     */\n    getButtons(editor) {\n        const buttons = [];\n        // Not used at the moment.\n        // eslint-disable-next-line no-unused-vars\n        const sel = editor.selection.getContent();\n        Object.values(this.components).forEach(component => {\n            buttons.push({\n                id: component.id,\n                name: component.displayname,\n                type: component.categoryname,\n                imageClass: 'elements-' + component.name + '-icon',\n                htmlcode: component.code,\n                variants: this.getComponentVariants(component),\n                flavorlist: component.flavors.join(','),\n                category: component.categoryname,\n                displayorder: component.displayorder,\n            });\n        });\n        buttons.sort((a, b) => a.displayorder - b.displayorder);\n\n        return buttons;\n    }\n\n    /**\n     * Get the template context for the dialogue.\n     *\n     * @param {Editor} editor\n     * @returns {object} data\n     */\n    getTemplateContext(editor) {\n        return Object.assign({}, {\n            elementid: editor.id,\n            buttons: this.getButtons(editor),\n            categories: this.getCategories(),\n            preview: this.previewElements,\n            canmanage: this.canManage,\n        });\n    }\n\n    getPreviewElements() {\n        return this.previewElements;\n    }\n\n    /**\n     * Get language strings.\n     *\n     * @return {object} Language strings\n     */\n    async getAllStrings() {\n        const keys = [];\n        const compRegex = /{{#([^}]*)}}/g;\n\n        this.components.forEach(element => {\n            // Get lang strings from components.\n            [...element.code.matchAll(compRegex)].forEach(strLang => {\n                if (keys.indexOf(strLang[1]) === -1) {\n                    keys.push(strLang[1]);\n                }\n            });\n\n            // Get lang strings from text placeholders.\n            [...element.text.matchAll(compRegex)].forEach(strLang => {\n                if (keys.indexOf(strLang[1]) === -1) {\n                    keys.push(strLang[1]);\n                }\n            });\n        });\n\n        const stringValues = await getStrings(keys.map((key) => ({key, pluginname})));\n        return new Map(keys.map((key, index) => ([key, stringValues[index]])));\n    }\n\n    async loadElementsData() {\n        const data = await fetchMany([{\n            methodname: 'tiny_elements_get_elements_data',\n            args: {\n                isstudent: this.userStudent,\n                contextid: this.contextid\n            },\n        }])[0].catch(err => {\n            Log.error(err.message);\n        });\n\n        const indexedComponents = [];\n        data.components.forEach(component => {\n            indexedComponents[component.id] = component;\n        });\n\n        const indexedVariants = [];\n        data.variants.forEach(variant => {\n            indexedVariants[variant.id] = variant;\n        });\n\n        const indexedCategories = [];\n        data.categories.forEach(category => {\n            indexedCategories[category.id] = category;\n        });\n\n        this.components = indexedComponents;\n        this.variants = indexedVariants;\n        this.categories = indexedCategories;\n        this.flavors = data.flavors;\n    }\n\n    /**\n     * Calculates flex-basis to space elements evenly.\n     */\n    setFlexbasis() {\n        // 5 elements should fit in one row.\n        let rows = Math.round(this.categories.length / 5);\n        if (rows < 1) {\n            rows = 1;\n        }\n        let elementsPerRow = Math.ceil(this.categories.length / rows);\n        return 100 / elementsPerRow;\n    }\n}\n"],"names":["constructor","contextid","userStudent","previewElements","canManage","this","loadElementsData","langStrings","getAllStrings","getComponents","components","getFlavors","flavors","getVariants","variants","getComponentById","id","getCategoryFlavors","categoryname","categoryFlavors","forEach","flavor","push","name","displayname","displayorder","getCategories","cats","flexbasis","setFlexbasis","categories","category","sort","a","b","hasFlavors","Array","isArray","length","flexbasisrng","Math","floor","random","categoryid","type","active","factive","getComponentVariants","component","componentVariants","variant","variantitem","undefined","state","imageClass","variantclass","c4lcompatibility","title","get","content","localeCompare","getCategoryById","getLangString","getButtons","editor","buttons","selection","getContent","Object","values","htmlcode","code","flavorlist","join","getTemplateContext","assign","elementid","preview","canmanage","getPreviewElements","keys","compRegex","element","matchAll","strLang","indexOf","text","stringValues","map","key","pluginname","Map","index","data","methodname","args","isstudent","catch","err","error","message","indexedComponents","indexedVariants","indexedCategories","rows","round","ceil"],"mappings":"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"}